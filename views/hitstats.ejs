<!DOCTYPE html>
<html lang="ru">
<head>
    <%- include('partials/head') %>
    <title>Hit Stats - Статистика попаданий</title>
    <link rel="stylesheet" href="/style.css">
    <style>
        html, body { height: 100%; overflow-y: auto; }
        .hitstats-page { padding: 32px; max-width: 1600px; margin: 0 auto; min-height: 100vh; }
        
        /* Header */
        .page-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }
        .header-left { display: flex; align-items: center; gap: 16px; }
        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #718C44 0%, #5a7038 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .header-icon svg { width: 24px; height: 24px; color: white; }
        .header-title { font-size: 24px; font-weight: 700; color: var(--text); }
        .header-meta { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            margin-top: 4px;
            font-size: 13px; 
            color: var(--text-muted); 
        }
        .views-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: rgba(113, 140, 68, 0.15);
            padding: 3px 10px;
            border-radius: 20px;
            color: #718C44;
            font-weight: 600;
            font-size: 12px;
        }
        .views-badge svg { width: 14px; height: 14px; }
        .back-btn { 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 10px 18px; 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            color: var(--text); 
            border-radius: 10px; 
            text-decoration: none; 
            font-size: 13px; 
            font-weight: 500;
            transition: all 0.2s; 
        }
        .back-btn:hover { border-color: #718C44; color: #718C44; }
        .back-btn svg { width: 16px; height: 16px; }

        /* Stats Cards */
        .stats-row { 
            display: grid; 
            grid-template-columns: repeat(4, 1fr); 
            gap: 16px; 
            margin-bottom: 28px; 
        }
        @media (max-width: 900px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 500px) { .stats-row { grid-template-columns: 1fr; } }
        .stat-box { 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: 12px; 
            padding: 18px 20px;
            display: flex;
            align-items: center;
            gap: 14px;
        }
        .stat-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .stat-icon svg { width: 22px; height: 22px; }
        .stat-icon.players { background: rgba(99, 102, 241, 0.15); color: #6366f1; }
        .stat-icon.hits { background: rgba(16, 185, 129, 0.15); color: #10b981; }
        .stat-icon.headshots { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .stat-icon.percent { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
        .stat-content { }
        .stat-value { font-size: 22px; font-weight: 700; color: var(--text); }
        .stat-label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-top: 2px; }

        /* Toolbar */
        .toolbar { 
            display: flex; 
            gap: 12px; 
            margin-bottom: 24px; 
            flex-wrap: wrap;
            align-items: center;
        }
        .search-box { 
            flex: 1; 
            min-width: 280px; 
            max-width: 400px; 
            position: relative; 
        }
        .search-box svg { 
            position: absolute; 
            left: 14px; 
            top: 50%; 
            transform: translateY(-50%); 
            width: 18px; 
            height: 18px; 
            color: var(--text-muted);
            pointer-events: none;
        }
        .search-input { 
            width: 100%; 
            padding: 12px 16px 12px 44px; 
            background: var(--bg-secondary); 
            border: 1px solid var(--border); 
            border-radius: 10px; 
            color: var(--text); 
            font-size: 14px;
            transition: all 0.2s;
        }
        .search-input:focus { outline: none; border-color: #718C44; box-shadow: 0 0 0 3px rgba(113, 140, 68, 0.1); }
        .search-input::placeholder { color: var(--text-muted); }

        /* Custom Select */
        .custom-select { 
            position: relative; 
            min-width: 180px;
        }
        .select-trigger {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .select-trigger:hover { border-color: var(--text-muted); }
        .select-trigger.open { border-color: #718C44; }
        .select-trigger svg.trigger-icon { width: 18px; height: 18px; color: #718C44; flex-shrink: 0; }
        .select-trigger span { flex: 1; font-size: 14px; color: var(--text); }
        .select-trigger svg.chevron { 
            width: 16px; 
            height: 16px; 
            color: var(--text-muted); 
            transition: transform 0.2s;
        }
        .select-trigger.open svg.chevron { transform: rotate(180deg); }
        .select-dropdown {
            position: absolute;
            top: calc(100% + 6px);
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 10px;
            overflow: hidden;
            z-index: 100;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-8px);
            transition: all 0.2s;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .select-dropdown.open { opacity: 1; visibility: visible; transform: translateY(0); }
        .select-option {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            cursor: pointer;
            transition: all 0.15s;
        }
        .select-option:hover { background: var(--bg-tertiary); }
        .select-option.active { background: rgba(113, 140, 68, 0.15); }
        .select-option svg { width: 18px; height: 18px; color: var(--text-muted); flex-shrink: 0; }
        .select-option.active svg { color: #718C44; }
        .select-option span { font-size: 14px; color: var(--text); }
        .select-option.active span { color: #718C44; font-weight: 500; }

        /* Players Table */
        .players-table {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
            overflow: hidden;
        }
        .table-header {
            display: grid;
            grid-template-columns: 50px 1fr 120px 100px 100px 140px;
            gap: 12px;
            padding: 14px 20px;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        @media (max-width: 800px) {
            .table-header { display: none; }
        }
        .player-row {
            display: grid;
            grid-template-columns: 50px 1fr 120px 100px 100px 140px;
            gap: 12px;
            padding: 14px 20px;
            align-items: center;
            border-bottom: 1px solid var(--border);
            text-decoration: none;
            transition: all 0.15s;
        }
        .player-row:last-child { border-bottom: none; }
        .player-row:hover { background: var(--bg-tertiary); }
        @media (max-width: 800px) {
            .player-row {
                grid-template-columns: 1fr auto;
                grid-template-rows: auto auto;
                gap: 8px 16px;
                padding: 16px;
            }
        }
        .player-rank {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-muted);
            text-align: center;
        }
        .player-rank.top-1 { color: #fbbf24; }
        .player-rank.top-2 { color: #9ca3af; }
        .player-rank.top-3 { color: #cd7f32; }
        .player-info {
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 0;
        }
        .player-avatar {
            width: 42px;
            height: 42px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
        }
        .player-avatar.loading {
            background: linear-gradient(90deg, var(--bg-tertiary) 25%, var(--bg-secondary) 50%, var(--bg-tertiary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }
        @keyframes shimmer { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
        .player-avatar img { width: 100%; height: 100%; object-fit: cover; }
        .player-avatar svg { width: 22px; height: 22px; color: var(--text-muted); }
        .player-details { min-width: 0; }
        .player-name { 
            font-size: 14px; 
            font-weight: 600; 
            color: var(--text); 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis;
            margin-bottom: 2px;
        }
        .player-steamid { 
            font-size: 11px; 
            color: var(--text-muted); 
            font-family: monospace;
        }
        .player-stat-cell {
            text-align: center;
        }
        .player-stat-cell .value {
            font-size: 16px;
            font-weight: 700;
            color: var(--text);
        }
        .player-stat-cell .label {
            font-size: 10px;
            color: var(--text-muted);
            display: none;
        }
        @media (max-width: 800px) {
            .player-stat-cell .label { display: block; margin-top: 2px; }
        }
        .player-stat-cell.headshots .value { color: #ef4444; }
        .player-stat-cell.hsrate .value { color: #718C44; }
        .player-actions {
            display: flex;
            justify-content: flex-end;
        }
        .view-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            padding: 0;
            background: rgba(113, 140, 68, 0.1);
            border: 1px solid rgba(113, 140, 68, 0.3);
            border-radius: 8px;
            color: #718C44;
            transition: all 0.2s;
        }
        .view-btn:hover {
            background: rgba(113, 140, 68, 0.2);
            border-color: #718C44;
        }
        .view-btn svg { width: 18px; height: 18px; }

        /* Mobile stats */
        @media (max-width: 800px) {
            .player-rank { grid-row: span 2; align-self: center; }
            .player-info { grid-column: 1; }
            .player-actions { grid-column: 2; grid-row: 1; }
            .mobile-stats {
                grid-column: 1 / -1;
                display: flex;
                gap: 16px;
                padding-top: 8px;
            }
            .player-stat-cell { text-align: left; flex: 1; }
        }
        .mobile-stats { display: none; }
        @media (max-width: 800px) { 
            .mobile-stats { display: flex; }
            .desktop-stat { display: none; }
        }

        .empty-state { 
            text-align: center; 
            padding: 60px 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 14px;
        }
        .empty-state svg { width: 64px; height: 64px; color: var(--text-muted); margin-bottom: 16px; opacity: 0.5; }
        .empty-state p { color: var(--text-secondary); font-size: 15px; }
    </style>
</head>
<body>
    <div class="hitstats-page">
        <div class="page-header">
            <div class="header-left">
                <div class="header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="6"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                </div>
                <div>
                    <div class="header-title">Hit Stats</div>
                    <div class="header-meta">
                        Статистика попаданий
                        <span class="views-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                <circle cx="12" cy="12" r="3"/>
                            </svg>
                            <%= pageViews ? pageViews.unique : 0 %>
                        </span>
                    </div>
                </div>
            </div>
            <a href="/" class="back-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                На главную
            </a>
        </div>
        
        <%
        const playersArray = [];
        let totalHitsAll = 0;
        let totalHeadshotsAll = 0;
        
        Object.entries(hitStatsData).forEach(([steamId, player]) => {
            if (player && player.Total > 0) {
                totalHitsAll += player.Total;
                totalHeadshotsAll += player.Head || 0;
                
                const headRate = player.Total > 0 ? ((player.Head || 0) / player.Total * 100).toFixed(1) : 0;
                
                playersArray.push({
                    steamId,
                    name: player.Name || 'Unknown',
                    total: player.Total,
                    head: player.Head || 0,
                    headRate
                });
            }
        });
        
        playersArray.sort((a, b) => b.total - a.total);
        const avgHeadRate = totalHitsAll > 0 ? (totalHeadshotsAll / totalHitsAll * 100).toFixed(1) : 0;
        %>
        
        <div class="stats-row">
            <div class="stat-box">
                <div class="stat-icon players">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                        <circle cx="9" cy="7" r="4"/>
                        <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                        <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value"><%= playersArray.length %></div>
                    <div class="stat-label">Игроков</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon hits">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="6"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value"><%= totalHitsAll.toLocaleString() %></div>
                    <div class="stat-label">Попаданий</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon headshots">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="8" r="5"/>
                        <path d="M20 21a8 8 0 0 0-16 0"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value"><%= totalHeadshotsAll.toLocaleString() %></div>
                    <div class="stat-label">Хедшотов</div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-icon percent">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="19" y1="5" x2="5" y2="19"/>
                        <circle cx="6.5" cy="6.5" r="2.5"/>
                        <circle cx="17.5" cy="17.5" r="2.5"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-value"><%= avgHeadRate %>%</div>
                    <div class="stat-label">Средний HS</div>
                </div>
            </div>
        </div>
        
        <div class="toolbar">
            <div class="search-box">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="M21 21l-4.35-4.35"/>
                </svg>
                <input type="text" class="search-input" id="searchInput" placeholder="Поиск по нику или Steam ID...">
            </div>
            
            <div class="custom-select" id="sortSelect">
                <div class="select-trigger" id="selectTrigger">
                    <svg class="trigger-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"/>
                        <circle cx="12" cy="12" r="6"/>
                        <circle cx="12" cy="12" r="2"/>
                    </svg>
                    <span id="selectedText">По попаданиям</span>
                    <svg class="chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="select-dropdown" id="selectDropdown">
                    <div class="select-option active" data-value="total">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <circle cx="12" cy="12" r="6"/>
                            <circle cx="12" cy="12" r="2"/>
                        </svg>
                        <span>По попаданиям</span>
                    </div>
                    <div class="select-option" data-value="head">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="8" r="5"/>
                            <path d="M20 21a8 8 0 0 0-16 0"/>
                        </svg>
                        <span>По хедшотам</span>
                    </div>
                    <div class="select-option" data-value="headrate">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="5" x2="5" y2="19"/>
                            <circle cx="6.5" cy="6.5" r="2.5"/>
                            <circle cx="17.5" cy="17.5" r="2.5"/>
                        </svg>
                        <span>По HS%</span>
                    </div>
                </div>
            </div>
        </div>

        <% if (playersArray.length === 0) { %>
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <circle cx="12" cy="12" r="10"/>
                <path d="M8 15h8"/>
                <path d="M9 9h.01"/>
                <path d="M15 9h.01"/>
            </svg>
            <p>Нет данных о попаданиях</p>
        </div>
        <% } else { %>
        <div class="players-table">
            <div class="table-header">
                <div>#</div>
                <div>Игрок</div>
                <div style="text-align:center">Попадания</div>
                <div style="text-align:center">Хедшоты</div>
                <div style="text-align:center">HS%</div>
                <div></div>
            </div>
            <div id="playersContainer">
                <% playersArray.forEach((player, index) => { %>
                <a href="/stats/<%= player.steamId %>" class="player-row" 
                   data-steamid="<%= player.steamId %>" 
                   data-name="<%= player.name.toLowerCase() %>"
                   data-total="<%= player.total %>" 
                   data-head="<%= player.head %>" 
                   data-headrate="<%= player.headRate %>">
                    <div class="player-rank <%= index === 0 ? 'top-1' : index === 1 ? 'top-2' : index === 2 ? 'top-3' : '' %>">
                        <%= index + 1 %>
                    </div>
                    <div class="player-info">
                        <div class="player-avatar loading" data-steamid="<%= player.steamId %>">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>
                        </div>
                        <div class="player-details">
                            <div class="player-name"><%= player.name %></div>
                            <div class="player-steamid"><%= player.steamId %></div>
                        </div>
                    </div>
                    <div class="player-stat-cell desktop-stat">
                        <div class="value"><%= player.total %></div>
                    </div>
                    <div class="player-stat-cell headshots desktop-stat">
                        <div class="value"><%= player.head %></div>
                    </div>
                    <div class="player-stat-cell hsrate desktop-stat">
                        <div class="value"><%= player.headRate %>%</div>
                    </div>
                    <div class="player-actions">
                        <div class="view-btn">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </div>
                    </div>
                    <div class="mobile-stats">
                        <div class="player-stat-cell">
                            <div class="value"><%= player.total %></div>
                            <div class="label">Попаданий</div>
                        </div>
                        <div class="player-stat-cell headshots">
                            <div class="value"><%= player.head %></div>
                            <div class="label">Хедшотов</div>
                        </div>
                        <div class="player-stat-cell hsrate">
                            <div class="value"><%= player.headRate %>%</div>
                            <div class="label">HS%</div>
                        </div>
                    </div>
                </a>
                <% }); %>
            </div>
        </div>
        <% } %>
    </div>

    <script>
        const playersData = <%- JSON.stringify(playersArray) %>;
        
        // Загрузка Steam аватаров
        async function loadSteamAvatars() {
            const steamIds = playersData.map(p => p.steamId);
            const batchSize = 100;
            
            for (let i = 0; i < steamIds.length; i += batchSize) {
                const batch = steamIds.slice(i, i + batchSize);
                try {
                    const res = await fetch('/api/steam/profiles?ids=' + batch.join(','));
                    if (res.ok) {
                        const profiles = await res.json();
                        profiles.forEach(p => {
                            const avatarEl = document.querySelector(`.player-avatar[data-steamid="${p.steamid}"]`);
                            if (avatarEl && (p.avatarmedium || p.avatar)) {
                                avatarEl.classList.remove('loading');
                                avatarEl.innerHTML = `<img src="${p.avatarmedium || p.avatar}" alt="">`;
                            }
                        });
                    }
                } catch(e) { console.error('Avatar load error:', e); }
            }
        }
        
        loadSteamAvatars();
        
        // Кастомный селект
        const trigger = document.getElementById('selectTrigger');
        const dropdown = document.getElementById('selectDropdown');
        const selectedText = document.getElementById('selectedText');
        const options = document.querySelectorAll('.select-option');
        
        trigger.addEventListener('click', () => {
            trigger.classList.toggle('open');
            dropdown.classList.toggle('open');
        });
        
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.custom-select')) {
                trigger.classList.remove('open');
                dropdown.classList.remove('open');
            }
        });
        
        options.forEach(opt => {
            opt.addEventListener('click', () => {
                options.forEach(o => o.classList.remove('active'));
                opt.classList.add('active');
                selectedText.textContent = opt.querySelector('span').textContent;
                
                // Обновляем иконку
                const icon = opt.querySelector('svg').cloneNode(true);
                icon.classList.add('trigger-icon');
                trigger.querySelector('.trigger-icon').replaceWith(icon);
                
                trigger.classList.remove('open');
                dropdown.classList.remove('open');
                
                // Сортировка
                sortPlayers(opt.dataset.value);
            });
        });
        
        function sortPlayers(sortBy) {
            const container = document.getElementById('playersContainer');
            const rows = [...container.querySelectorAll('.player-row')];
            
            rows.sort((a, b) => {
                switch(sortBy) {
                    case 'total': return b.dataset.total - a.dataset.total;
                    case 'head': return b.dataset.head - a.dataset.head;
                    case 'headrate': return parseFloat(b.dataset.headrate) - parseFloat(a.dataset.headrate);
                    default: return 0;
                }
            });
            
            rows.forEach((row, i) => {
                const rank = row.querySelector('.player-rank');
                rank.textContent = i + 1;
                rank.className = 'player-rank' + (i === 0 ? ' top-1' : i === 1 ? ' top-2' : i === 2 ? ' top-3' : '');
                container.appendChild(row);
            });
        }
        
        // Поиск
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.player-row').forEach(row => {
                const steamid = row.dataset.steamid.toLowerCase();
                const name = row.dataset.name;
                row.style.display = (steamid.includes(query) || name.includes(query)) ? '' : 'none';
            });
        });
    </script>
</body>
</html>
